<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Gæ¤œå®š å­¦ç¿’ã‚¢ãƒ—ãƒª</title>
<style>
:root {
  --green: #10b981;
  --teal: #06b6d4;
  --orange: #f59e0b;
  --red: #ef4444;
  --bg: #0f172a;
  --card: #1e293b;
  --card-hover: #334155;
  --text: #f1f5f9;
  --text-sub: #94a3b8;
  --accent: #6366f1;
  --accent-hover: #818cf8;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

.header {
  background: linear-gradient(135deg, #1e1b4b, #312e81);
  padding: 20px;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
.header h1 { font-size: 1.3rem; font-weight: 700; letter-spacing: 0.05em; }
.header-sub { font-size: 0.75rem; color: var(--text-sub); margin-top: 4px; }

.screen { display: none; padding: 16px; padding-bottom: 100px; }
.screen.active { display: block; }

.overall-stats {
  background: linear-gradient(135deg, var(--card), #253348);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  text-align: center;
}
.overall-rate {
  font-size: 2.8rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--teal));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.overall-label { font-size: 0.85rem; color: var(--text-sub); margin-top: 4px; }
.overall-detail {
  display: flex; justify-content: center; gap: 24px;
  margin-top: 12px; font-size: 0.85rem; color: var(--text-sub);
}

.section-title {
  font-size: 1rem; font-weight: 700; margin: 24px 0 12px;
  display: flex; align-items: center; gap: 8px;
}

.chapter-card {
  background: var(--card); border-radius: 12px; padding: 16px;
  margin-bottom: 12px; border-left: 4px solid transparent; transition: transform 0.15s;
}
.chapter-card:active { transform: scale(0.98); }
.chapter-card.excellent { border-left-color: var(--green); }
.chapter-card.good { border-left-color: var(--teal); }
.chapter-card.needs-work { border-left-color: var(--orange); }
.chapter-card.weak { border-left-color: var(--red); }

.chapter-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
}
.chapter-name { font-size: 0.9rem; font-weight: 600; flex: 1; margin-right: 12px; }
.chapter-rate { font-size: 1.3rem; font-weight: 800; }
.chapter-card.excellent .chapter-rate { color: var(--green); }
.chapter-card.good .chapter-rate { color: var(--teal); }
.chapter-card.needs-work .chapter-rate { color: var(--orange); }
.chapter-card.weak .chapter-rate { color: var(--red); }

.chapter-detail { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 8px; }

.progress-bar {
  width: 100%; height: 6px; background: rgba(255,255,255,0.1);
  border-radius: 3px; overflow: hidden;
}
.progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
.chapter-card.excellent .progress-fill { background: var(--green); }
.chapter-card.good .progress-fill { background: var(--teal); }
.chapter-card.needs-work .progress-fill { background: var(--orange); }
.chapter-card.weak .progress-fill { background: var(--red); }

.badge {
  display: inline-block; font-size: 0.65rem; font-weight: 700;
  padding: 2px 8px; border-radius: 10px; margin-left: 8px; vertical-align: middle;
}
.badge.excellent { background: rgba(16,185,129,0.2); color: var(--green); }
.badge.good { background: rgba(6,182,212,0.2); color: var(--teal); }
.badge.needs-work { background: rgba(245,158,11,0.2); color: var(--orange); }
.badge.weak { background: rgba(239,68,68,0.2); color: var(--red); }

.chapter-select-card {
  background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 10px;
  display: flex; justify-content: space-between; align-items: center;
  cursor: pointer; transition: background 0.15s;
}
.chapter-select-card:active { background: var(--card-hover); }
.chapter-select-info h3 { font-size: 0.9rem; font-weight: 600; }
.chapter-select-info p { font-size: 0.75rem; color: var(--text-sub); margin-top: 2px; }
.chapter-select-arrow { color: var(--text-sub); font-size: 1.2rem; }

.quiz-progress { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.quiz-progress-bar { flex: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
.quiz-progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; }
.quiz-progress-text { font-size: 0.8rem; color: var(--text-sub); white-space: nowrap; }

.question-card {
  background: var(--card); border-radius: 16px; padding: 24px 20px; margin-bottom: 16px;
}
.question-number { font-size: 0.75rem; color: var(--accent); font-weight: 700; margin-bottom: 8px; }
.question-text { font-size: 1rem; line-height: 1.7; font-weight: 500; }
.question-type {
  display: inline-block; font-size: 0.7rem; font-weight: 700; padding: 2px 8px;
  border-radius: 8px; margin-top: 8px;
  background: rgba(245,158,11,0.2); color: var(--orange);
}

.choices { display: flex; flex-direction: column; gap: 10px; }
.choice-btn {
  background: var(--card); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px;
  padding: 14px 16px; color: var(--text); font-size: 0.9rem; line-height: 1.5;
  text-align: left; cursor: pointer; transition: all 0.15s;
  display: flex; align-items: flex-start; gap: 10px;
}
.choice-btn:active { transform: scale(0.98); }
.choice-btn:hover { border-color: var(--accent); }
.choice-btn.selected { border-color: var(--accent); background: rgba(99,102,241,0.15); }
.choice-btn.selected .choice-label { background: var(--accent); color: #fff; }
.choice-label {
  display: inline-flex; align-items: center; justify-content: center;
  width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.1);
  font-size: 0.8rem; font-weight: 700; flex-shrink: 0;
}
.choice-text { padding-top: 3px; }

.choice-btn.correct { border-color: var(--green); background: rgba(16,185,129,0.15); }
.choice-btn.correct .choice-label { background: var(--green); color: #fff; }
.choice-btn.incorrect { border-color: var(--red); background: rgba(239,68,68,0.15); }
.choice-btn.incorrect .choice-label { background: var(--red); color: #fff; }
.choice-btn.show-correct { border-color: var(--green); background: rgba(16,185,129,0.1); }

.submit-btn {
  width: 100%; padding: 14px; border-radius: 12px; border: none;
  font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 16px;
  background: var(--accent); color: #fff; transition: all 0.15s;
  display: none;
}
.submit-btn.show { display: block; }
.submit-btn:hover { background: var(--accent-hover); }
.submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.result-box {
  margin-top: 16px; padding: 16px; border-radius: 12px; display: none;
}
.result-box.show { display: block; }
.result-box.correct-result { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); }
.result-box.incorrect-result { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); }
.result-icon { font-size: 1.5rem; margin-bottom: 8px; }
.result-explanation { font-size: 0.85rem; line-height: 1.6; color: var(--text-sub); margin-top: 8px; }

.next-btn, .copy-btn {
  width: 100%; padding: 14px; border-radius: 12px; border: none;
  font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 12px; transition: all 0.15s;
}
.next-btn { background: var(--accent); color: #fff; }
.next-btn:hover { background: var(--accent-hover); }
.copy-btn {
  background: rgba(255,255,255,0.1); color: var(--text);
  border: 1px solid rgba(255,255,255,0.2); font-size: 0.85rem;
}
.copy-btn:active { background: rgba(255,255,255,0.2); }
.copy-btn.copied { background: rgba(16,185,129,0.2); border-color: var(--green); color: var(--green); }

.summary-hero { text-align: center; padding: 40px 20px; }
.summary-score { font-size: 4rem; font-weight: 800; }
.summary-score.great { color: var(--green); }
.summary-score.good { color: var(--teal); }
.summary-score.needs-work { color: var(--orange); }
.summary-score.poor { color: var(--red); }
.summary-label { font-size: 1rem; color: var(--text-sub); margin-top: 4px; }
.summary-detail { display: flex; justify-content: center; gap: 32px; margin-top: 20px; }
.summary-detail-item { text-align: center; }
.summary-detail-num { font-size: 1.5rem; font-weight: 700; }
.summary-detail-label { font-size: 0.75rem; color: var(--text-sub); }

.summary-q-item {
  background: var(--card); border-radius: 12px; padding: 14px 16px;
  margin-bottom: 8px; display: flex; align-items: flex-start; gap: 12px;
}
.summary-q-icon { font-size: 1.2rem; flex-shrink: 0; padding-top: 2px; }
.summary-q-text { font-size: 0.85rem; line-height: 1.5; flex: 1; }
.summary-q-copy {
  background: none; border: 1px solid rgba(255,255,255,0.2); color: var(--text-sub);
  font-size: 0.7rem; padding: 4px 10px; border-radius: 6px; cursor: pointer;
  white-space: nowrap; flex-shrink: 0; transition: all 0.15s;
}
.summary-q-copy:active { background: rgba(16,185,129,0.2); border-color: var(--green); color: var(--green); }

.action-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 24px; }
.btn-primary {
  background: var(--accent); color: #fff; border: none; padding: 16px;
  border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: background 0.15s;
}
.btn-primary:hover { background: var(--accent-hover); }
.btn-secondary {
  background: rgba(255,255,255,0.08); color: var(--text);
  border: 1px solid rgba(255,255,255,0.15); padding: 14px; border-radius: 12px;
  font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background 0.15s;
}
.btn-secondary:hover { background: rgba(255,255,255,0.12); }

.mode-cards { display: flex; flex-direction: column; gap: 12px; margin-top: 16px; }
.mode-card {
  background: var(--card); border-radius: 12px; padding: 20px; cursor: pointer;
  border: 2px solid transparent; transition: all 0.15s;
}
.mode-card:hover { border-color: var(--accent); }
.mode-card:active { transform: scale(0.98); }
.mode-card h3 { font-size: 1rem; font-weight: 700; margin-bottom: 4px; }
.mode-card p { font-size: 0.8rem; color: var(--text-sub); line-height: 1.4; }

.no-data { text-align: center; padding: 40px 20px; color: var(--text-sub); }
.no-data-icon { font-size: 3rem; margin-bottom: 12px; }
.no-data p { font-size: 0.9rem; line-height: 1.6; }

.toast {
  position: fixed; bottom: 30px; left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--card); color: var(--text); padding: 12px 24px;
  border-radius: 12px; font-size: 0.85rem; font-weight: 600;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4); z-index: 200;
  transition: transform 0.3s ease; pointer-events: none;
}
.toast.show { transform: translateX(-50%) translateY(0); }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in { animation: fadeIn 0.3s ease forwards; }

.reset-area { margin-top: 40px; text-align: center; }
.reset-btn {
  background: none; border: 1px solid rgba(239,68,68,0.3); color: var(--red);
  padding: 10px 20px; border-radius: 8px; font-size: 0.8rem; cursor: pointer;
}
.reset-btn:hover { background: rgba(239,68,68,0.1); }

.overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  z-index: 300; align-items: center; justify-content: center;
}
.overlay.show { display: flex; }
.dialog {
  background: var(--card); border-radius: 16px; padding: 24px; margin: 20px;
  max-width: 320px; width: 100%; text-align: center;
}
.dialog h3 { font-size: 1.1rem; margin-bottom: 8px; }
.dialog p { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 20px; line-height: 1.5; }
.dialog-btns { display: flex; gap: 10px; }
.dialog-btns button {
  flex: 1; padding: 12px; border-radius: 10px; font-size: 0.9rem;
  font-weight: 600; cursor: pointer; border: none;
}
.dialog-cancel { background: rgba(255,255,255,0.1); color: var(--text); }
.dialog-confirm { background: var(--red); color: #fff; }

.loading {
  text-align: center; padding: 60px 20px; color: var(--text-sub);
}
.loading-spinner {
  width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin: 0 auto 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="header">
  <h1>Gæ¤œå®š å­¦ç¿’ã‚¢ãƒ—ãƒª</h1>
  <div class="header-sub">JDLA Deep Learning for GENERAL</div>
</div>

<div class="toast" id="toast"></div>

<div class="overlay" id="resetOverlay">
  <div class="dialog">
    <h3>ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</h3>
    <p>ã™ã¹ã¦ã®å­¦ç¿’è¨˜éŒ²ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
    <div class="dialog-btns">
      <button class="dialog-cancel" onclick="closeResetDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="dialog-confirm" onclick="confirmReset()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>
</div>

<div class="screen active" id="topScreen">
  <div id="overallStats"></div>
  <div id="chapterAnalysis"></div>
  <div class="section-title">å­¦ç¿’ã‚’å§‹ã‚ã‚‹</div>
  <div class="mode-cards">
    <div class="mode-card" onclick="showChapterSelect('normal')">
      <h3>ç« ã‚’é¸ã‚“ã§å­¦ç¿’</h3>
      <p>ç« ã”ã¨ã«å•é¡Œã‚’è§£ã„ã¦ç†è§£åº¦ã‚’ç¢ºèª</p>
    </div>
    <div class="mode-card" onclick="startReviewMode()">
      <h3>é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’</h3>
      <p>éå»ã«ä¸æ­£è§£ã ã£ãŸå•é¡Œã‚’é‡ç‚¹çš„ã«å¾©ç¿’</p>
    </div>
    <div class="mode-card" onclick="showChapterSelect('all')">
      <h3>å…¨ç« ãƒ©ãƒ³ãƒ€ãƒ </h3>
      <p>å…¨ç¯„å›²ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œ</p>
    </div>
  </div>
  <div class="reset-area">
    <button class="reset-btn" onclick="showResetDialog()">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<div class="screen" id="chapterSelectScreen">
  <div class="section-title">
    <span onclick="goTop()" style="cursor:pointer;">â†</span>
    ç« ã‚’é¸æŠ
  </div>
  <div id="chapterList"></div>
</div>

<div class="screen" id="quizScreen">
  <div class="quiz-progress">
    <span onclick="confirmQuit()" style="cursor:pointer;font-size:1.2rem;">â†</span>
    <div class="quiz-progress-bar">
      <div class="quiz-progress-fill" id="quizProgressFill"></div>
    </div>
    <div class="quiz-progress-text" id="quizProgressText">1/10</div>
  </div>
  <div id="quizContent"></div>
</div>

<div class="screen" id="summaryScreen">
  <div id="summaryContent"></div>
</div>

<!-- å¤–éƒ¨å•é¡Œãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ -->
<script src="questions.js"></script>

<script>
// ===== questions.js ãŒèª­ã¿è¾¼ã‚ãªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ =====
if (typeof QUESTIONS === 'undefined') {
  var QUESTIONS = [
    {
      id: 1, chapter: 1, chapterName: "äººå·¥çŸ¥èƒ½ï¼ˆAIï¼‰ã¨ã¯",
      question: "ã‚µãƒ³ãƒ—ãƒ«å•é¡Œï¼šç¬¬1æ¬¡AIãƒ–ãƒ¼ãƒ ï¼ˆ1950å¹´ä»£å¾ŒåŠã€œ1960å¹´ä»£ï¼‰ã®ä¸­å¿ƒæŠ€è¡“ã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã‹ã€‚",
      choices: ["çŸ¥è­˜è¡¨ç¾ã¨ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ", "æ¨è«–ã¨æ¢ç´¢", "æ©Ÿæ¢°å­¦ç¿’ã¨ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°", "ç”ŸæˆAIã¨å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«"],
      correct: [1],
      explanation: "ç¬¬1æ¬¡AIãƒ–ãƒ¼ãƒ ã§ã¯ã€Œæ¨è«–ãƒ»æ¢ç´¢ã€ãŒä¸­å¿ƒæŠ€è¡“ã§ã—ãŸã€‚ã“ã‚Œã¯ã‚µãƒ³ãƒ—ãƒ«å•é¡Œã§ã™ã€‚questions.jsã«å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚"
    }
  ];
}

// ===== CHAPTERSï¼ˆå•é¡Œãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•ç”Ÿæˆï¼‰ =====
function getChapters() {
  const chapters = {};
  QUESTIONS.forEach(q => {
    if (!chapters[q.chapter]) chapters[q.chapter] = q.chapterName;
  });
  return chapters;
}

const LABELS = ['A','B','C','D','E','F','G','H'];

// ===== STATE =====
let progress = loadProgress();
let currentQuiz = [];
let currentIndex = 0;
let quizResults = [];
let currentMode = 'normal';
let selectedChoices = new Set();
let isMultiSelect = false;

function loadProgress() {
  try {
    const data = localStorage.getItem('gTestProgress');
    return data ? JSON.parse(data) : {};
  } catch { return {}; }
}
function saveProgress() {
  localStorage.setItem('gTestProgress', JSON.stringify(progress));
}

// ===== NAVIGATION =====
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}
function goTop() { renderTop(); showScreen('topScreen'); }

// ===== TOP SCREEN =====
function renderTop() { renderOverallStats(); renderChapterAnalysis(); }

function renderOverallStats() {
  const el = document.getElementById('overallStats');
  const allAnswered = Object.keys(progress);
  if (allAnswered.length === 0) {
    el.innerHTML = `
      <div class="no-data fade-in">
        <div class="no-data-icon">ğŸ“š</div>
        <p>ã¾ã å•é¡Œã‚’è§£ã„ã¦ã„ã¾ã›ã‚“ã€‚<br>ä¸‹ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å­¦ç¿’ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼<br><br>
        <span style="font-size:0.75rem;color:var(--text-sub)">å…¨${QUESTIONS.length}å•åéŒ²</span></p>
      </div>`;
    return;
  }
  let totalCorrect = 0, totalCount = 0;
  allAnswered.forEach(qid => { totalCount++; if (progress[qid].correct) totalCorrect++; });
  const rate = Math.round((totalCorrect / totalCount) * 100);
  el.innerHTML = `
    <div class="overall-stats fade-in">
      <div class="overall-rate">${rate}%</div>
      <div class="overall-label">å…¨ä½“æ­£ç­”ç‡</div>
      <div class="overall-detail">
        <span>æ­£è§£ ${totalCorrect}å•</span>
        <span>ä¸æ­£è§£ ${totalCount - totalCorrect}å•</span>
        <span>åˆè¨ˆ ${totalCount}/${QUESTIONS.length}å•</span>
      </div>
    </div>`;
}

function renderChapterAnalysis() {
  const el = document.getElementById('chapterAnalysis');
  const allAnswered = Object.keys(progress);
  if (allAnswered.length === 0) { el.innerHTML = ''; return; }

  const stats = {};
  allAnswered.forEach(qid => {
    const q = QUESTIONS.find(q => q.id === parseInt(qid));
    if (!q) return;
    const ch = q.chapter;
    if (!stats[ch]) stats[ch] = { total: 0, correct: 0, incorrect: 0, name: q.chapterName };
    stats[ch].total++;
    if (progress[qid].correct) stats[ch].correct++;
    else stats[ch].incorrect++;
  });

  const sorted = Object.entries(stats).map(([ch, s]) => {
    s.rate = Math.round((s.correct / s.total) * 100);
    s.chapter = ch;
    return s;
  }).sort((a, b) => a.rate - b.rate);

  let html = '<div class="section-title">ç« åˆ¥åˆ†æï¼ˆè‹¦æ‰‹é †ï¼‰</div>';
  sorted.forEach((s, i) => {
    const cls = s.rate >= 80 ? 'excellent' : s.rate >= 60 ? 'good' : s.rate >= 40 ? 'needs-work' : 'weak';
    const label = s.rate >= 80 ? 'å„ªç§€' : s.rate >= 60 ? 'è‰¯å¥½' : s.rate >= 40 ? 'è¦æ”¹å–„' : 'è‹¦æ‰‹';
    const chapterTotal = QUESTIONS.filter(q => q.chapter === parseInt(s.chapter)).length;
    html += `
      <div class="chapter-card ${cls} fade-in" style="animation-delay:${i*0.05}s">
        <div class="chapter-header">
          <div class="chapter-name">ç¬¬${s.chapter}ç« : ${s.name}<span class="badge ${cls}">${label}</span></div>
          <div class="chapter-rate">${s.rate}%</div>
        </div>
        <div class="chapter-detail">æ­£è§£: ${s.correct}å•ã€€ä¸æ­£è§£: ${s.incorrect}å•ã€€ï¼ˆ${s.total}/${chapterTotal}å• å›ç­”æ¸ˆï¼‰</div>
        <div class="progress-bar"><div class="progress-fill" style="width:${s.rate}%"></div></div>
      </div>`;
  });
  el.innerHTML = html;
}

// ===== CHAPTER SELECT =====
function showChapterSelect(mode) {
  currentMode = mode;
  if (mode === 'all') { startQuiz(QUESTIONS.slice()); return; }
  const el = document.getElementById('chapterList');
  const chapters = getChapters();
  let html = '';
  Object.entries(chapters).forEach(([ch, name]) => {
    const qs = QUESTIONS.filter(q => q.chapter === parseInt(ch));
    const answered = qs.filter(q => progress[q.id]).length;
    html += `
      <div class="chapter-select-card fade-in" onclick="startChapterQuiz(${ch})">
        <div class="chapter-select-info">
          <h3>ç¬¬${ch}ç« : ${name}</h3>
          <p>${qs.length}å•ï¼ˆ${answered}å• å›ç­”æ¸ˆï¼‰</p>
        </div>
        <div class="chapter-select-arrow">â€º</div>
      </div>`;
  });
  el.innerHTML = html;
  showScreen('chapterSelectScreen');
}

function startChapterQuiz(chapter) {
  startQuiz(QUESTIONS.filter(q => q.chapter === chapter));
}

function startReviewMode() {
  const wrongIds = Object.entries(progress).filter(([_,v]) => !v.correct).map(([id,_]) => parseInt(id));
  const qs = QUESTIONS.filter(q => wrongIds.includes(q.id));
  if (qs.length === 0) { showToast('å¾©ç¿’ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  currentMode = 'review';
  startQuiz(qs);
}

// ===== QUIZ =====
function startQuiz(questions) {
  currentQuiz = questions.sort(() => Math.random() - 0.5);
  currentIndex = 0;
  quizResults = [];
  showScreen('quizScreen');
  renderQuestion();
}

function renderQuestion() {
  const q = currentQuiz[currentIndex];
  const total = currentQuiz.length;
  const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
  isMultiSelect = correctArr.length > 1;
  selectedChoices = new Set();

  document.getElementById('quizProgressFill').style.width = `${(currentIndex/total)*100}%`;
  document.getElementById('quizProgressText').textContent = `${currentIndex+1}/${total}`;

  let choicesHtml = '';
  q.choices.forEach((c, i) => {
    choicesHtml += `
      <button class="choice-btn" id="choice${i}" onclick="${isMultiSelect ? `toggleChoice(${i})` : `selectSingleAnswer(${i})`}">
        <span class="choice-label">${LABELS[i]}</span>
        <span class="choice-text">${c}</span>
      </button>`;
  });

  const typeTag = isMultiSelect ? `<div class="question-type">è¤‡æ•°é¸æŠï¼ˆ${correctArr.length}ã¤é¸æŠï¼‰</div>` : '';

  document.getElementById('quizContent').innerHTML = `
    <div class="question-card fade-in">
      <div class="question-number">ç¬¬${q.chapter}ç« : ${q.chapterName}</div>
      <div class="question-text">${q.question}</div>
      ${typeTag}
    </div>
    <div class="choices fade-in" style="animation-delay:0.1s">${choicesHtml}</div>
    <button class="submit-btn" id="submitBtn" onclick="submitMultiAnswer()" disabled>å›ç­”ã‚’ç¢ºå®šã™ã‚‹</button>
    <div class="result-box" id="resultBox">
      <div class="result-icon" id="resultIcon"></div>
      <div class="result-explanation" id="resultExplanation"></div>
      <button class="copy-btn" id="copyBtn" onclick="copyQuestion()">å•é¡Œã¨è§£èª¬ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆAIå£æ‰“ã¡ç”¨ï¼‰</button>
      <button class="next-btn" id="nextBtn" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸</button>
    </div>`;

  if (isMultiSelect) {
    document.getElementById('submitBtn').classList.add('show');
  }
}

// å˜ä¸€é¸æŠ
function selectSingleAnswer(selected) {
  selectedChoices = new Set([selected]);
  evaluateAnswer();
}

// è¤‡æ•°é¸æŠã®ãƒˆã‚°ãƒ«
function toggleChoice(idx) {
  const btn = document.getElementById('choice' + idx);
  if (selectedChoices.has(idx)) {
    selectedChoices.delete(idx);
    btn.classList.remove('selected');
  } else {
    selectedChoices.add(idx);
    btn.classList.add('selected');
  }
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = selectedChoices.size === 0;
}

// è¤‡æ•°é¸æŠã®ç¢ºå®š
function submitMultiAnswer() {
  evaluateAnswer();
}

// å›ç­”è©•ä¾¡
function evaluateAnswer() {
  const q = currentQuiz[currentIndex];
  const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
  const selectedArr = Array.from(selectedChoices).sort();
  const correctSorted = correctArr.slice().sort();
  const isCorrect = JSON.stringify(selectedArr) === JSON.stringify(correctSorted);

  progress[q.id] = { correct: isCorrect, lastAnswered: Date.now() };
  saveProgress();
  quizResults.push({ question: q, selected: selectedArr, isCorrect });

  // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
  if (document.getElementById('submitBtn')) {
    document.getElementById('submitBtn').style.display = 'none';
  }

  document.querySelectorAll('.choice-btn').forEach((btn, i) => {
    btn.onclick = null;
    btn.style.cursor = 'default';
    if (correctArr.includes(i)) {
      btn.classList.remove('selected');
      btn.classList.add(selectedArr.includes(i) ? 'correct' : 'show-correct');
    } else if (selectedArr.includes(i)) {
      btn.classList.remove('selected');
      btn.classList.add('incorrect');
    }
  });

  const box = document.getElementById('resultBox');
  box.classList.add('show');
  box.classList.add(isCorrect ? 'correct-result' : 'incorrect-result');
  document.getElementById('resultIcon').textContent = isCorrect ? 'â­• æ­£è§£ï¼' : 'âŒ ä¸æ­£è§£';
  document.getElementById('resultExplanation').textContent = q.explanation;

  if (currentIndex >= currentQuiz.length - 1) {
    document.getElementById('nextBtn').textContent = 'çµæœã‚’è¦‹ã‚‹';
  }
}

function nextQuestion() {
  currentIndex++;
  if (currentIndex >= currentQuiz.length) showSummary();
  else { renderQuestion(); window.scrollTo(0, 0); }
}

function copyQuestion() {
  const q = currentQuiz[currentIndex];
  const r = quizResults[quizResults.length - 1];
  const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
  const text = `ã€Gæ¤œå®š å•é¡Œã€‘
ç¬¬${q.chapter}ç« : ${q.chapterName}

â–  å•é¡Œ
${q.question}

â–  é¸æŠè‚¢
${q.choices.map((c,i) => `${LABELS[i]}. ${c}`).join('\n')}

â–  æ­£è§£: ${correctArr.map(i => LABELS[i]+'. '+q.choices[i]).join(', ')}
â–  è‡ªåˆ†ã®å›ç­”: ${r.selected.map(i => LABELS[i]+'. '+q.choices[i]).join(', ')}

â–  è§£èª¬
${q.explanation}

---
ã“ã®å•é¡Œã«ã¤ã„ã¦ã•ã‚‰ã«æ·±ãç†è§£ã—ãŸã„ã§ã™ã€‚é–¢é€£ã™ã‚‹æ¦‚å¿µã‚„å®Ÿå‹™ã§ã®å¿œç”¨ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚`;

  navigator.clipboard.writeText(text).then(() => {
    document.getElementById('copyBtn').textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
    document.getElementById('copyBtn').classList.add('copied');
    showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }).catch(() => {
    fallbackCopy(text);
    document.getElementById('copyBtn').textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
    document.getElementById('copyBtn').classList.add('copied');
    showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  });
}

function confirmQuit() {
  if (quizResults.length > 0) {
    if (confirm('å­¦ç¿’ã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿã“ã“ã¾ã§ã®å›ç­”ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚')) goTop();
  } else goTop();
}

// ===== SUMMARY =====
function showSummary() {
  showScreen('summaryScreen');
  const total = quizResults.length;
  const correct = quizResults.filter(r => r.isCorrect).length;
  const rate = Math.round((correct/total)*100);
  const cls = rate>=80?'great':rate>=60?'good':rate>=40?'needs-work':'poor';
  const wrongResults = quizResults.filter(r => !r.isCorrect);

  let wrongHtml = '';
  if (wrongResults.length > 0) {
    wrongHtml = '<div class="section-title" style="margin-top:32px">é–“é•ãˆãŸå•é¡Œ</div>';
    wrongResults.forEach((r,i) => {
      const q = r.question;
      wrongHtml += `
        <div class="summary-q-item fade-in" style="animation-delay:${i*0.05}s">
          <div class="summary-q-icon">âŒ</div>
          <div class="summary-q-text"><strong>ç¬¬${q.chapter}ç« </strong> ${q.question.substring(0,60)}...</div>
          <button class="summary-q-copy" onclick="copySummaryQuestion(${quizResults.indexOf(r)})">ã‚³ãƒ”ãƒ¼</button>
        </div>`;
    });
  }

  document.getElementById('summaryContent').innerHTML = `
    <div class="summary-hero fade-in">
      <div class="summary-score ${cls}">${rate}%</div>
      <div class="summary-label">æ­£ç­”ç‡</div>
      <div class="summary-detail">
        <div class="summary-detail-item">
          <div class="summary-detail-num" style="color:var(--green)">${correct}</div>
          <div class="summary-detail-label">æ­£è§£</div>
        </div>
        <div class="summary-detail-item">
          <div class="summary-detail-num" style="color:var(--red)">${total-correct}</div>
          <div class="summary-detail-label">ä¸æ­£è§£</div>
        </div>
        <div class="summary-detail-item">
          <div class="summary-detail-num">${total}</div>
          <div class="summary-detail-label">åˆè¨ˆ</div>
        </div>
      </div>
    </div>
    <div class="summary-questions">${wrongHtml}</div>
    ${wrongResults.length>0?`<button class="btn-secondary" style="margin-top:16px" onclick="copyAllWrong()">é–“é•ãˆãŸå•é¡Œã‚’ã™ã¹ã¦ã‚³ãƒ”ãƒ¼</button>`:''}
    <div class="action-btns">
      <button class="btn-primary" onclick="goTop()">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
      ${wrongResults.length>0?'<button class="btn-secondary" onclick="retryWrong()">é–“é•ãˆãŸå•é¡Œã ã‘å†æŒ‘æˆ¦</button>':''}
    </div>`;
}

function copySummaryQuestion(idx) {
  const r = quizResults[idx];
  const q = r.question;
  const correctArr = Array.isArray(q.correct)?q.correct:[q.correct];
  const text = `ã€Gæ¤œå®š å•é¡Œã€‘
ç¬¬${q.chapter}ç« : ${q.chapterName}

â–  å•é¡Œ
${q.question}

â–  é¸æŠè‚¢
${q.choices.map((c,i)=>`${LABELS[i]}. ${c}`).join('\n')}

â–  æ­£è§£: ${correctArr.map(i=>LABELS[i]+'. '+q.choices[i]).join(', ')}
â–  è‡ªåˆ†ã®å›ç­”: ${r.selected.map(i=>LABELS[i]+'. '+q.choices[i]).join(', ')}

â–  è§£èª¬
${q.explanation}

---
ã“ã®å•é¡Œã«ã¤ã„ã¦ã€ãªãœé–“é•ãˆãŸã‹åˆ†æã—ã€é–¢é€£ã™ã‚‹æ¦‚å¿µã‚’æ•™ãˆã¦ãã ã•ã„ã€‚`;

  navigator.clipboard.writeText(text).then(()=>showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(()=>{fallbackCopy(text);showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');});
}

function copyAllWrong() {
  const wrongs = quizResults.filter(r=>!r.isCorrect);
  let text = 'ã€Gæ¤œå®š é–“é•ãˆãŸå•é¡Œã¾ã¨ã‚ã€‘\n\n';
  wrongs.forEach((r,i) => {
    const q = r.question;
    const correctArr = Array.isArray(q.correct)?q.correct:[q.correct];
    text += `â”â”â” å•é¡Œ${i+1} â”â”â”
ç¬¬${q.chapter}ç« : ${q.chapterName}

â–  å•é¡Œ
${q.question}

â–  é¸æŠè‚¢
${q.choices.map((c,j)=>`${LABELS[j]}. ${c}`).join('\n')}

â–  æ­£è§£: ${correctArr.map(i=>LABELS[i]+'. '+q.choices[i]).join(', ')}
â–  è‡ªåˆ†ã®å›ç­”: ${r.selected.map(i=>LABELS[i]+'. '+q.choices[i]).join(', ')}

â–  è§£èª¬
${q.explanation}

`;
  });
  text += `---\nä¸Šè¨˜ã®é–“é•ãˆãŸå•é¡Œã«ã¤ã„ã¦ã€å…±é€šã™ã‚‹å¼±ç‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æã—ã€åŠ¹ç‡çš„ãªå¾©ç¿’æ–¹æ³•ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚`;
  navigator.clipboard.writeText(text).then(()=>showToast('ã™ã¹ã¦ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(()=>{fallbackCopy(text);showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');});
}

function retryWrong() {
  startQuiz(quizResults.filter(r=>!r.isCorrect).map(r=>r.question));
}

// ===== UTILITIES =====
function fallbackCopy(text) {
  const ta=document.createElement('textarea');ta.value=text;ta.style.position='fixed';
  ta.style.left='-9999px';document.body.appendChild(ta);ta.select();
  document.execCommand('copy');document.body.removeChild(ta);
}
function showToast(msg) {
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2000);
}
function showResetDialog(){document.getElementById('resetOverlay').classList.add('show');}
function closeResetDialog(){document.getElementById('resetOverlay').classList.remove('show');}
function confirmReset(){
  progress={};localStorage.removeItem('gTestProgress');
  closeResetDialog();showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');goTop();
}

// ===== INIT =====
renderTop();
</script>
</body>
</html>
